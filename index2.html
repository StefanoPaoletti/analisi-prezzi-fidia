<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fidia Analytics Pro</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Poppins', sans-serif; 
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 50%, #06b6d4 100%);
            min-height: 100vh;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        .neon-border {
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.5),
                        0 0 40px rgba(59, 130, 246, 0.3),
                        inset 0 0 20px rgba(59, 130, 246, 0.1);
        }
        .stat-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }
        .stat-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }
        .product-card {
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .product-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transition: left 0.5s;
        }
        .product-card:hover::before {
            left: 100%;
        }
        .product-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
        }
        .profit-bar {
            height: 6px;
            background: linear-gradient(90deg, #ef4444, #f59e0b, #10b981);
            border-radius: 10px;
            margin-top: 8px;
        }
        .animated-bg {
            animation: gradientShift 15s ease infinite;
            background: linear-gradient(-45deg, #1e3a8a, #3b82f6, #06b6d4, #0ea5e9);
            background-size: 400% 400%;
        }
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .pulse-dot {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
        .tab-indicator {
            position: absolute;
            bottom: 0;
            height: 3px;
            background: linear-gradient(90deg, #3b82f6, #06b6d4);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 10px 10px 0 0;
        }
        input:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }
        .search-input {
            transition: all 0.3s ease;
        }
        .search-input:focus {
            width: 100%;
            background: white;
        }
        .modal-overlay {
            backdrop-filter: blur(8px);
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .slide-up {
            animation: slideUp 0.3s ease;
        }
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        /* Scrollbar personalizzata */
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.1); }
        ::-webkit-scrollbar-thumb { 
            background: rgba(59, 130, 246, 0.6); 
            border-radius: 10px; 
        }
        ::-webkit-scrollbar-thumb:hover { background: rgba(59, 130, 246, 0.8); }
    </style>
</head>
<body class="animated-bg">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        const PRODUCTS = [
          'PROLENS', 'OPTO RED', 'OPTO SOL', 'OPTO YAL', 'OPTO YAL CREAM', 'OPTO GEL', 'OPTO IDRO',
          'OPTO RELAX', 'OPTO VITREO', 'RESPILENS 100', 'RESPILENS 360', 'OPTO CARE', 'OPTO MYO',
          'OPTO OMEGA', 'BLU GEL', 'BLU YAL', 'IRIDIUM GARZE', 'TRIUM',
          'VITREOXIGEN', 'LUTEINOMEGA', 'MERAMIRT', 'MYRIALEN GEL',
          'MERAMIRT CM', 'MERAMIRT XG', 'LACRISEK'
        ].sort();
        
        const YEARS = ['2019', '2020', '2021', '2022', '2023', '2024', '2025', '2026'];
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxv9Xxi4i-Kw0pPK8Xd7YYFpqr992YCoTd7mZog77PYDlXosRMnY_3sQ6hZOC5pBgVq/exec';

        function App() {
          const [isAuthenticated, setIsAuthenticated] = useState(false);
          const [password, setPassword] = useState('');
          const [savedPassword, setSavedPassword] = useState('');
          const [activeTab, setActiveTab] = useState('overview');
          const [invoices, setInvoices] = useState([]);
          const [creditNotes, setCreditNotes] = useState([]);
          const [onlinePrices, setOnlinePrices] = useState({});
          const [selectedYear, setSelectedYear] = useState(new Date().getFullYear().toString());
          const [isLoading, setIsLoading] = useState(false);
          const [searchTerm, setSearchTerm] = useState('');
          const [sortBy, setSortBy] = useState('margin'); // margin, name, quantity
          const [showModal, setShowModal] = useState(false);
          const [selectedProduct, setSelectedProduct] = useState(null);
          
          const priceTimerRef = useRef(null);

          useEffect(() => {
            const stored = localStorage.getItem('fidiaAppPassword');
            if (stored) { 
              setSavedPassword(stored); 
              setIsAuthenticated(true); 
              loadFromGoogleSheets(stored); 
            }
          }, []);

          const loadFromGoogleSheets = async (pwd = savedPassword) => {
            setIsLoading(true);
            try {
              const response = await fetch(SCRIPT_URL);
              if (!response.ok) throw new Error('Errore server');
              const data = await response.json();
              
              const invoiceMap = {};
              (data.invoices || []).forEach(row => {
                if (!invoiceMap[row.id]) {
                  let dateStr = row.date;
                  if (typeof dateStr === 'string' && dateStr.includes('-')) {
                    dateStr = dateStr.split('T')[0];
                  }
                  invoiceMap[row.id] = {
                    id: row.id, year: row.year, date: dateStr, 
                    number: row.number, shippingCost: row.shippingCost || 0, items: []
                  };
                }
                invoiceMap[row.id].items.push({
                  product: row.product, quantity: row.quantity, priceGross: row.priceGross,
                  priceNet: row.priceNet, discount: row.discount || 0, vat: row.vat, freebies: row.freebies
                });
              });
              
              setInvoices(Object.values(invoiceMap));
              setCreditNotes(data.creditNotes || []);
              setOnlinePrices(data.onlinePrices || {});
            } catch (error) {
              console.error('Errore caricamento:', error);
            }
            setIsLoading(false);
          };

          const savePrice = async (product, price) => {
            try {
              await fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({ password: savedPassword, action: 'saveOnlinePrice', product, price }),
                mode: 'no-cors'
              });
            } catch (error) {
              console.error(error);
            }
          };

          const handleLogin = () => {
            if (!password) return;
            localStorage.setItem('fidiaAppPassword', password);
            setSavedPassword(password);
            setIsAuthenticated(true);
            loadFromGoogleSheets(password);
          };

          const analysis = useMemo(() => {
            const result = {};
            const filteredInvoices = selectedYear === 'all' ? invoices : invoices.filter(inv => String(inv.year) === selectedYear);
            
            const totalCostByYear = {};
            filteredInvoices.forEach(invoice => {
              const year = String(invoice.year);
              if (!totalCostByYear[year]) totalCostByYear[year] = 0;
              const totalPieces = invoice.items.reduce((sum, i) => sum + (parseFloat(i.quantity) || 0) + (parseFloat(i.freebies) || 0), 0);
              const shipping = parseFloat(invoice.shippingCost) || 0;
              
              invoice.items.forEach(item => {
                const qty = parseFloat(item.quantity) || 0;
                const free = parseFloat(item.freebies) || 0;
                const netPrice = parseFloat(item.priceNet || item.price) || 0;
                const vat = parseFloat(item.vat) || 0;
                const totalQty = qty + free;
                const shippingShare = totalPieces > 0 ? (totalQty / totalPieces) * shipping : 0;
                const priceWithVAT = qty * netPrice * (1 + vat / 100);
                const shippingWithVAT = shippingShare * 1.22;
                totalCostByYear[year] += priceWithVAT + shippingWithVAT;
              });
            });

            PRODUCTS.forEach(product => {
              let totalCost = 0, totalQuantity = 0, yearCost = {};
              
              filteredInvoices.forEach(invoice => {
                const totalPieces = invoice.items.reduce((sum, i) => sum + (parseFloat(i.quantity) || 0) + (parseFloat(i.freebies) || 0), 0);
                const shipping = parseFloat(invoice.shippingCost) || 0;
                
                invoice.items.forEach(item => {
                  if (item.product !== product) return;
                  const qty = parseFloat(item.quantity) || 0, free = parseFloat(item.freebies) || 0;
                  const netPrice = parseFloat(item.priceNet || item.price) || 0, vat = parseFloat(item.vat) || 0;
                  const totalQty = qty + free;
                  const shippingShare = totalPieces > 0 ? (totalQty / totalPieces) * shipping : 0;
                  const priceWithVAT = qty * netPrice * (1 + vat / 100);
                  const shippingWithVAT = shippingShare * 1.22;
                  const itemCost = priceWithVAT + shippingWithVAT;
                  totalCost += itemCost; totalQuantity += totalQty;
                  if (!yearCost[invoice.year]) yearCost[invoice.year] = 0;
                  yearCost[invoice.year] += itemCost;
                });
              });
              
              const relevantCredits = selectedYear === 'all' ? creditNotes : creditNotes.filter(c => String(c.year) === selectedYear);
              relevantCredits.forEach(c => {
                const creditYear = String(c.year);
                if (yearCost[creditYear] && totalCostByYear[creditYear]) {
                  const prop = yearCost[creditYear] / totalCostByYear[creditYear];
                  yearCost[creditYear] -= c.amount * prop;
                }
              });

              totalCost = Object.values(yearCost).reduce((s, v) => s + v, 0);
              const avg = totalQuantity > 0 ? totalCost / totalQuantity : 0;
              const online = parseFloat(onlinePrices[product]) || 0;
              const margin = online > 0 ? ((online - avg) / online) * 100 : 0;
              
              result[product] = { avg, online, margin, qty: totalQuantity };
            });
            
            return result;
          }, [invoices, creditNotes, onlinePrices, selectedYear]);

          const stats = useMemo(() => {
            const totalCost = Object.values(analysis).reduce((s, d) => s + (d.avg * d.qty), 0);
            const totalRevenue = Object.values(analysis).reduce((s, d) => s + (d.online * d.qty), 0);
            const profit = totalRevenue - totalCost;
            const avgMargin = Object.values(analysis).filter(d => d.qty > 0).reduce((s, d) => s + d.margin, 0) / 
                             Math.max(Object.values(analysis).filter(d => d.qty > 0).length, 1);
            const totalPieces = Object.values(analysis).reduce((s, d) => s + d.qty, 0);
            const topProducts = Object.entries(analysis)
              .filter(([, d]) => d.qty > 0)
              .sort((a, b) => (b[1].online * b[1].qty) - (a[1].online * a[1].qty))
              .slice(0, 5);
            
            return { totalCost, totalRevenue, profit, avgMargin, totalPieces, topProducts };
          }, [analysis]);

          const filteredProducts = useMemo(() => {
            let filtered = Object.entries(analysis)
              .filter(([name, data]) => {
                if (data.qty === 0) return false;
                if (!searchTerm) return true;
                return name.toLowerCase().includes(searchTerm.toLowerCase());
              });

            if (sortBy === 'margin') filtered.sort((a, b) => b[1].margin - a[1].margin);
            else if (sortBy === 'name') filtered.sort((a, b) => a[0].localeCompare(b[0]));
            else if (sortBy === 'quantity') filtered.sort((a, b) => b[1].qty - a[1].qty);

            return filtered;
          }, [analysis, searchTerm, sortBy]);

          if (!isAuthenticated) {
            return (
              <div className="min-h-screen flex items-center justify-center p-6">
                <div className="glass-card rounded-3xl p-12 w-full max-w-md slide-up">
                  <div className="text-center mb-8">
                    <div className="w-20 h-20 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-2xl mx-auto mb-6 flex items-center justify-center text-4xl">
                      üëì
                    </div>
                    <h1 className="text-4xl font-black text-gray-800 mb-2">Fidia Analytics</h1>
                    <p className="text-gray-500 font-medium">Gestione intelligente dell'inventario</p>
                  </div>
                  <input 
                    type="password" 
                    value={password} 
                    onChange={e => setPassword(e.target.value)} 
                    onKeyPress={e => e.key === 'Enter' && handleLogin()} 
                    className="w-full px-6 py-4 rounded-2xl border-2 border-gray-200 mb-4 font-medium transition-all"
                    placeholder="Inserisci password" 
                  />
                  <button 
                    onClick={handleLogin} 
                    className="w-full bg-gradient-to-r from-blue-600 to-cyan-600 text-white py-4 rounded-2xl font-bold text-lg shadow-lg hover:shadow-xl transition-all hover:scale-[1.02]"
                  >
                    Accedi ‚Üí
                  </button>
                </div>
              </div>
            );
          }

          return (
            <div className="min-h-screen p-4 md:p-8">
              {/* Header */}
              <header className="glass-card rounded-3xl p-6 mb-6 slide-up">
                <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                  <div className="flex items-center gap-4">
                    <div className="w-14 h-14 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-xl flex items-center justify-center text-2xl">
                      üëì
                    </div>
                    <div>
                      <h1 className="text-3xl font-black text-gray-800">Fidia Analytics</h1>
                      <p className="text-gray-500 text-sm font-medium">Ottica Paoletti</p>
                    </div>
                  </div>
                  <div className="flex items-center gap-3 w-full md:w-auto">
                    <select 
                      value={selectedYear} 
                      onChange={e => setSelectedYear(e.target.value)} 
                      className="px-4 py-3 rounded-xl border-2 border-gray-200 font-bold text-sm bg-white cursor-pointer hover:border-blue-400 transition-all"
                    >
                      <option value="all">üìÖ Tutto</option>
                      {YEARS.map(y => <option key={y} value={y}>{y}</option>)}
                    </select>
                    <button 
                      onClick={() => loadFromGoogleSheets()} 
                      className="px-4 py-3 bg-white rounded-xl border-2 border-gray-200 hover:border-blue-400 transition-all"
                      disabled={isLoading}
                    >
                      {isLoading ? '‚è≥' : 'üîÑ'}
                    </button>
                    <button 
                      onClick={() => { localStorage.clear(); location.reload(); }} 
                      className="px-4 py-3 bg-red-50 text-red-600 rounded-xl font-bold hover:bg-red-100 transition-all"
                    >
                      üö™
                    </button>
                  </div>
                </div>

                {/* Tabs */}
                <div className="flex gap-2 mt-6 relative">
                  {['overview', 'products', 'prices'].map(tab => (
                    <button 
                      key={tab} 
                      onClick={() => setActiveTab(tab)} 
                      className={`px-6 py-3 rounded-xl font-bold text-sm transition-all ${activeTab === tab ? 'bg-gradient-to-r from-blue-600 to-cyan-600 text-white shadow-lg' : 'text-gray-600 hover:bg-gray-100'}`}
                    >
                      {tab === 'overview' ? 'üìä Panoramica' : tab === 'products' ? 'üì¶ Prodotti' : 'üí∞ Prezzi'}
                    </button>
                  ))}
                </div>
              </header>

              {isLoading && (
                <div className="fixed top-4 left-1/2 -translate-x-1/2 glass-card px-6 py-3 rounded-full z-50 flex items-center gap-3 slide-up">
                  <div className="w-2 h-2 bg-blue-500 rounded-full pulse-dot"></div>
                  <span className="font-bold text-sm">Caricamento...</span>
                </div>
              )}

              {/* PANORAMICA */}
              {activeTab === 'overview' && (
                <div className="space-y-6">
                  {/* Stats Cards */}
                  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div className="glass-card rounded-3xl p-6 stat-card border-l-4 border-orange-500">
                      <div className="flex justify-between items-start mb-4">
                        <div className="text-3xl">üí∞</div>
                        <div className="text-xs font-bold text-gray-500 bg-orange-100 px-3 py-1 rounded-full">COSTO</div>
                      </div>
                      <h3 className="text-3xl font-black text-gray-800 mb-1">
                        ‚Ç¨{stats.totalCost.toLocaleString('it-IT', {maximumFractionDigits:0})}
                      </h3>
                      <p className="text-sm font-medium text-gray-500">Investimento Totale</p>
                    </div>

                    <div className="glass-card rounded-3xl p-6 stat-card border-l-4 border-blue-500">
                      <div className="flex justify-between items-start mb-4">
                        <div className="text-3xl">üíµ</div>
                        <div className="text-xs font-bold text-gray-500 bg-blue-100 px-3 py-1 rounded-full">INCASSO</div>
                      </div>
                      <h3 className="text-3xl font-black text-gray-800 mb-1">
                        ‚Ç¨{stats.totalRevenue.toLocaleString('it-IT', {maximumFractionDigits:0})}
                      </h3>
                      <p className="text-sm font-medium text-gray-500">Potenziale</p>
                    </div>

                    <div className="glass-card rounded-3xl p-6 stat-card border-l-4 border-green-500">
                      <div className="flex justify-between items-start mb-4">
                        <div className="text-3xl">üìà</div>
                        <div className="text-xs font-bold text-gray-500 bg-green-100 px-3 py-1 rounded-full">PROFITTO</div>
                      </div>
                      <h3 className="text-3xl font-black text-green-600 mb-1">
                        ‚Ç¨{stats.profit.toLocaleString('it-IT', {maximumFractionDigits:0})}
                      </h3>
                      <p className="text-sm font-medium text-gray-500">Guadagno Stimato</p>
                    </div>

                    <div className="glass-card rounded-3xl p-6 stat-card border-l-4 border-purple-500">
                      <div className="flex justify-between items-start mb-4">
                        <div className="text-3xl">üéØ</div>
                        <div className="text-xs font-bold text-gray-500 bg-purple-100 px-3 py-1 rounded-full">MARGINE</div>
                      </div>
                      <h3 className={`text-3xl font-black mb-1 ${stats.avgMargin > 30 ? 'text-green-600' : stats.avgMargin > 20 ? 'text-yellow-600' : 'text-red-600'}`}>
                        {stats.avgMargin.toFixed(1)}%
                      </h3>
                      <p className="text-sm font-medium text-gray-500">Margine Medio</p>
                    </div>
                  </div>

                  {/* Top 5 Products */}
                  <div className="glass-card rounded-3xl p-8">
                    <h2 className="text-2xl font-black text-gray-800 mb-6 flex items-center gap-3">
                      üèÜ Top 5 Prodotti per Fatturato
                    </h2>
                    <div className="space-y-4">
                      {stats.topProducts.map(([name, data], idx) => (
                        <div key={name} className="flex items-center gap-4 p-4 bg-gradient-to-r from-gray-50 to-white rounded-2xl hover:from-blue-50 hover:to-cyan-50 transition-all cursor-pointer">
                          <div className="text-3xl font-black text-gray-300">#{idx + 1}</div>
                          <div className="flex-1">
                            <div className="flex justify-between items-start mb-2">
                              <div>
                                <h3 className="font-bold text-gray-800">{name}</h3>
                                <p className="text-sm text-gray-500">{data.qty} pezzi venduti</p>
                              </div>
                              <div className="text-right">
                                <div className="text-xl font-black text-blue-600">
                                  ‚Ç¨{(data.online * data.qty).toLocaleString('it-IT', {maximumFractionDigits:0})}
                                </div>
                                <div className={`text-sm font-bold ${data.margin > 30 ? 'text-green-600' : 'text-yellow-600'}`}>
                                  {data.margin.toFixed(1)}% margine
                                </div>
                              </div>
                            </div>
                            <div className="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                              <div 
                                className="h-full bg-gradient-to-r from-blue-500 to-cyan-500 rounded-full transition-all duration-500"
                                style={{ width: `${Math.min((data.margin / 50) * 100, 100)}%` }}
                              ></div>
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                </div>
              )}

              {/* PRODOTTI */}
              {activeTab === 'products' && (
                <div className="space-y-6">
                  {/* Search & Sort */}
                  <div className="glass-card rounded-3xl p-6">
                    <div className="flex flex-col md:flex-row gap-4">
                      <input 
                        type="text" 
                        value={searchTerm} 
                        onChange={e => setSearchTerm(e.target.value)} 
                        placeholder="üîç Cerca prodotto..." 
                        className="flex-1 px-6 py-4 rounded-2xl border-2 border-gray-200 font-medium search-input transition-all"
                      />
                      <select 
                        value={sortBy} 
                        onChange={e => setSortBy(e.target.value)} 
                        className="px-6 py-4 rounded-2xl border-2 border-gray-200 font-bold cursor-pointer hover:border-blue-400 transition-all bg-white"
                      >
                        <option value="margin">üìä Ordina per Margine</option>
                        <option value="name">üî§ Ordina per Nome</option>
                        <option value="quantity">üì¶ Ordina per Quantit√†</option>
                      </select>
                    </div>
                  </div>

                  {/* Products Grid */}
                  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    {filteredProducts.map(([name, data]) => (
                      <div 
                        key={name} 
                        className="glass-card rounded-3xl p-6 product-card cursor-pointer"
                        onClick={() => { setSelectedProduct({name, data}); setShowModal(true); }}
                      >
                        <div className="flex justify-between items-start mb-4">
                          <h3 className="font-bold text-gray-800 text-lg leading-tight">{name}</h3>
                          <div className={`text-xs font-black px-3 py-1 rounded-full ${data.margin > 30 ? 'bg-green-100 text-green-700' : data.margin > 20 ? 'bg-yellow-100 text-yellow-700' : 'bg-red-100 text-red-700'}`}>
                            {data.margin.toFixed(0)}%
                          </div>
                        </div>
                        
                        <div className="space-y-3">
                          <div>
                            <p className="text-xs text-gray-500 mb-1">Costo Reale</p>
                            <p className="text-xl font-black text-gray-800">‚Ç¨{data.avg.toFixed(2)}</p>
                          </div>
                          <div>
                            <p className="text-xs text-gray-500 mb-1">Prezzo Online</p>
                            <p className="text-xl font-black text-blue-600">‚Ç¨{data.online.toFixed(2)}</p>
                          </div>
                          <div>
                            <p className="text-xs text-gray-500 mb-1">Quantit√†</p>
                            <p className="text-lg font-bold text-gray-700">{data.qty} pz</p>
                          </div>
                        </div>
                        
                        <div className="profit-bar"></div>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {/* PREZZI */}
              {activeTab === 'prices' && (
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                  {PRODUCTS.map(prod => (
                    <div key={prod} className="glass-card rounded-3xl p-6 product-card">
                      <label className="text-xs font-bold text-gray-500 uppercase tracking-wider block mb-4">{prod}</label>
                      <div className="flex items-center gap-3 mb-2">
                        <span className="text-3xl font-black text-gray-300">‚Ç¨</span>
                        <input 
                          type="number" 
                          step="0.01" 
                          value={onlinePrices[prod] || ''} 
                          onChange={e => {
                            const v = e.target.value;
                            setOnlinePrices({...onlinePrices, [prod]: v});
                            if (priceTimerRef.current) clearTimeout(priceTimerRef.current);
                            priceTimerRef.current = setTimeout(() => savePrice(prod, parseFloat(v) || 0), 2000);
                          }} 
                          className="w-full text-3xl font-black text-gray-800 outline-none bg-transparent" 
                          placeholder="0.00"
                          disabled={isLoading}
                        />
                      </div>
                      <p className="text-xs text-gray-400 italic">Salvataggio automatico in 2 sec</p>
                    </div>
                  ))}
                </div>
              )}

              {/* Modal Dettagli Prodotto */}
              {showModal && selectedProduct && (
                <div className="fixed inset-0 bg-black/50 modal-overlay flex items-center justify-center p-6 z-50" onClick={() => setShowModal(false)}>
                  <div className="glass-card rounded-3xl p-8 max-w-2xl w-full slide-up" onClick={e => e.stopPropagation()}>
                    <div className="flex justify-between items-start mb-6">
                      <div>
                        <h2 className="text-3xl font-black text-gray-800">{selectedProduct.name}</h2>
                        <p className="text-gray-500 mt-1">Dettagli completi prodotto</p>
                      </div>
                      <button onClick={() => setShowModal(false)} className="text-3xl text-gray-400 hover:text-gray-600">√ó</button>
                    </div>
                    
                    <div className="grid grid-cols-2 gap-6 mb-6">
                      <div className="bg-gradient-to-br from-orange-50 to-orange-100 rounded-2xl p-6">
                        <p className="text-sm font-bold text-orange-600 mb-2">COSTO REALE</p>
                        <p className="text-4xl font-black text-gray-800">‚Ç¨{selectedProduct.data.avg.toFixed(2)}</p>
                      </div>
                      <div className="bg-gradient-to-br from-blue-50 to-blue-100 rounded-2xl p-6">
                        <p className="text-sm font-bold text-blue-600 mb-2">PREZZO VENDITA</p>
                        <p className="text-4xl font-black text-gray-800">‚Ç¨{selectedProduct.data.online.toFixed(2)}</p>
                      </div>
                      <div className="bg-gradient-to-br from-green-50 to-green-100 rounded-2xl p-6">
                        <p className="text-sm font-bold text-green-600 mb-2">MARGINE</p>
                        <p className="text-4xl font-black text-gray-800">{selectedProduct.data.margin.toFixed(1)}%</p>
                      </div>
                      <div className="bg-gradient-to-br from-purple-50 to-purple-100 rounded-2xl p-6">
                        <p className="text-sm font-bold text-purple-600 mb-2">QUANTIT√Ä</p>
                        <p className="text-4xl font-black text-gray-800">{selectedProduct.data.qty} pz</p>
                      </div>
                    </div>
                    
                    <div className="bg-gray-100 rounded-2xl p-6">
                      <h3 className="font-bold text-gray-800 mb-3">Analisi Profitto</h3>
                      <div className="space-y-2 text-sm">
                        <div className="flex justify-between">
                          <span className="text-gray-600">Guadagno per pezzo:</span>
                          <span className="font-bold text-green-600">‚Ç¨{(selectedProduct.data.online - selectedProduct.data.avg).toFixed(2)}</span>
                        </div>
                        <div className="flex justify-between">
                          <span className="text-gray-600">Profitto totale stimato:</span>
                          <span className="font-bold text-green-600">‚Ç¨{((selectedProduct.data.online - selectedProduct.data.avg) * selectedProduct.data.qty).toFixed(2)}</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              )}
            </div>
          );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
